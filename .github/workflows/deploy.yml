name: Deploy Rift to VPS

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # --- 1. BYGG SOCIAL (FRONTEND) ---
    - name: Build Social
      run: |
        cd RiftSocial
        npm ci
        npm run build
        tar -czf social-dist.tar.gz dist

    # --- 2. BYGG GAME (FORSIDEN) ---
    - name: Build Game
      run: |
        cd RiftGame
        npm ci
        npm run build
        tar -czf game-dist.tar.gz dist

    # --- 3. BYGG BACKEND ---
    - name: Build Backend
      run: |
        cd RiftBackend
        npm ci
        npm run build
        # Pakker med package.json og prisma ogs√•
        tar -czf backend-dist.tar.gz dist package.json package-lock.json prisma

    # --- 4. SEND FILER TIL SERVER ---
    - name: Copy files to VPS
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        source: "RiftSocial/social-dist.tar.gz,RiftGame/game-dist.tar.gz,RiftBackend/backend-dist.tar.gz"
        target: "/tmp/rift-deploy"
        strip_components: 1

    # --- 5. PAKK UT OG RESTART P√Ö SERVER ---
    - name: Deploy on VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "üöÄ Starter deployment..."
          
          # 1. Frontend: Social
          mkdir -p /var/www/riftgame/social
          rm -rf /var/www/riftgame/social/*
          tar -xzf /tmp/rift-deploy/social-dist.tar.gz -C /tmp
          cp -r /tmp/dist/* /var/www/riftgame/social/
          rm -rf /tmp/dist
          
          # 2. Frontend: Game
          tar -xzf /tmp/rift-deploy/game-dist.tar.gz -C /tmp
          cp -r /tmp/dist/* /var/www/riftgame/
          rm -rf /tmp/dist
          
          # 3. Backend
          echo "‚öôÔ∏è Oppdaterer Backend..."
          cd /var/www/riftmultiplayer-src/RiftBackend
          # Slett gammel dist for sikkerhets skyld
          rm -rf dist
          # Pakk ut ny kode
          tar -xzf /tmp/rift-deploy/backend-dist.tar.gz -C /var/www/riftmultiplayer-src/RiftBackend
          
          # Installer produksjons-pakker
          npm install --production
          
          # Database migrering
          npx prisma migrate deploy
          
          # Restart server
          pm2 restart riftbackend
          
          # Opprydding
          rm -rf /tmp/rift-deploy
          chown -R www-data:www-data /var/www/riftgame
          
          echo "‚úÖ Deployment ferdig!"